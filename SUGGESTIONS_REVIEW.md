# Student Voice Platform - Codebase Review & Suggestions

> **Autogenerated by Gemini**
> **Date:** February 21, 2026

After a deep dive into the `student-voice-platform` codebase, reviewing API flows, frontend state management, database interactions, and the existing `SUGGESTIONS_GEMINI.md` and `PENDING_TASKS.md`, here is a comprehensive list of actionable refactorings and improvements needed to make the application scalable, reliable, and production-ready.

---

## ðŸš¨ 1. Critical Reliability & Performance Issues (Must-Fix)

### 1.1 The In-Memory `AnalysisContext` Processing Loop
**Location:** `src/context/AnalysisContext.tsx`
**The Problem:** The `startAnalysis` function relies on a `while` loop running inside a React Context on the client side to chunk database records (50 at a time) and send them to the `/api/ai/run-analysis` endpoint. 
- If the user closes the browser tab, the analysis stops.
- If the browser sleeps or React unmounts poorly, the process is left in a zombie state or throws errors.
**The Fix:** Transition background tasks to a robust server-side message queue (e.g., Inngest, Upstash, or Supabase Edge Functions with triggers). The UI should only poll for the `analysis_status` percentage, rather than orchestrating the analysis loop itself.

### 1.2 "N+1" Query Bottlenecks in Views
**Locations:** `src/app/api/executive/metrics/route.ts` & `src/app/analysis/page.tsx`
**The Problem:** 
- In `/api/executive/metrics`, the server maps over all `orgUnits` and awaits `supabase.rpc('get_dashboard_metrics')` for *each* unit individually.
- In `loadDashboard()` for analysis, multiple `supabase.from('raw_feedback_inputs').select({ count: 'exact' })` queries are made *per unit* in a `Promise.all` loop.
**The Fix:** Create consolidated Supabase Views or single RPC functions that use `GROUP BY target_unit_id` to fetch all stats in exactly **one** database round-trip.

### 1.3 Client-Side Data Aggregation
**Locations:** Components like `PraisesRadar.tsx` & `IssuesRadar.tsx`
**The Problem:** Currently, these charts fetch *an array of all individual positive/negative segments* across the entire database over the wire to the browser, simply to run a JavaScript `.forEach()` loop to count them.
**The Fix:** Use a Supabase RPC or Database View to handle the `COUNT()` and `GROUP BY category_id, target_unit_id` on the database level, returning only the final, aggregated `[ {subject: "...", value: 45} ]` arrays to the frontend.

---

## ðŸ›  2. AI Stability & API Resiliency

### 2.1 Lack of Retry Mechanisms
**Locations:** `src/app/api/ai/*.ts` & `src/lib/ai.ts`
**The Problem:** Calls to `callGemini()` do not employ exponential backoff or retry mechanisms for common issues like Rate Limits (429) or transient server errors (500s).
**The Fix:** Wrap the AI generation SDK in a resilient retry utility (e.g., `p-retry` or a custom delay loop) to gracefully handle API limits without failing the entire batch analysis.

### 2.2 Unpredictable Batch Size Context Windows
**Locations:** `src/app/api/ai/run-analysis/route.ts`
**The Problem:** The batch size is hardcoded to 50 comments strings. If users submit highly verbose prose, 50 comments might exceed Gemini's prompt token limits, or cause the JSON structured output to truncate midway, breaking `JSON.parse()`.
**The Fix:** Implement token counting (or character approximation) to dynamically size batches before sending them to Gemini, ensuring the combined prompt + expected output safely fits within bounds.

---

## ðŸŽ¯ 3. Code Quality & Technical Debt

### 3.1 Overuse of `any` Types
**The Problem:** Despite a well-defined `src/types/index.ts` file, many critical junctures (API bodies, array maps) fallback to `any`.
**The Fix:** Enforce `eslint` strict typing rules. Ensure responses from the AI validation (Zod) seamlessly tie into the Type definitions.

### 3.2 Security: Row Level Security (RLS)
**The Problem:** As noted in `PENDING_TASKS.md`, the platform operates assuming a trusted client environment. There is no Row Level Security applied to standard tables.
**The Fix:** Implement Supabase Auth. Bind rows strictly to user ownership or role-based access control (RBAC).

---

## âœ¨ 4. Future UI/UX Polish

### 4.1 "Dirty State" Flagging
When an Admin edits or deletes a Category in the Taxonomy (Tab 1), there is currently no way to know which previously analyzed `feedback_segments` are now orphaned or stale. 
**Suggestion:** Add a `needs_reanalysis` boolean on `raw_feedback_inputs`, triggered by a Postgres function when corresponding Taxonomy entries change.

### 4.2 Error Boundaries & Fallback States
If an API route times out or a metric completely fails to calculate due to dividing by zero, the entire `Card` or page shouldn't break. 
**Suggestion:** Expand the use of React `<ErrorBoundary>` boundaries specifically around complex metric cards like `DependencyGraph.tsx` or `PraisesRadar.tsx` and provide a simple "Failed to load metric" state.

*(Note: Prioritize **Phase 1 and 2** before doing any production deployments!)*
